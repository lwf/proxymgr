#!/usr/bin/env ruby
$LOAD_PATH.unshift File.expand_path(File.join(__FILE__, '..', '..', 'lib'))

require 'proxymgr'
require 'logger'

ProxyMgr::Logging.level = Logger::DEBUG

haproxy         = ProxyMgr::Haproxy.new("/tmp/haproxy",
                                        "/tmp/haproxy.cfg",
                                        :socket => "/tmp/stats.sock")
if haproxy.version < 1.5
  $stderr.puts "ProxyMgr requires haproxy version 1.5 or later."
  exit 1
end

sink            = ProxyMgr::Sink.new(haproxy)
service_manager = ProxyMgr::ServiceManager.new(sink)
config          = ProxyMgr::Config.new(service_manager)

Signal.trap(:INT) do 
  Thread.new { service_manager.shutdown }.join
  exit 0
end

sleep
